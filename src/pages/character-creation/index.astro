---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { races } from '../../data/races';
import { classesData } from '../../data/classes';
import { backgrounds } from '../../data/backgrounds';
import { skills } from '../../data/skills';

const base = import.meta.env.BASE_URL.replace(/\/$/, '');

// Compact data for client-side use
const raceData = JSON.stringify(races);
const classData = JSON.stringify(classesData.map(c => ({
  name: c.name,
  slug: c.slug,
  hitDie: c.hitDie,
  primaryAbility: c.primaryAbility,
  savingThrows: c.savingThrows,
  armorProficiencies: c.armorProficiencies,
  weaponProficiencies: c.weaponProficiencies,
  toolProficiencies: c.toolProficiencies,
  skillChoices: c.skillChoices,
  description: c.description,
  subclassLabel: c.subclassLabel,
  subclassLevel: c.subclassLevel,
  subclasses: c.subclasses.map(sc => ({ name: sc.name, slug: sc.slug, description: sc.description, source: sc.source })),
})));
const bgData = JSON.stringify(backgrounds);
const skillData = JSON.stringify(skills);

const standardArray = [15, 14, 13, 12, 10, 8];
const abilities = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];
const abilityFull: Record<string, string> = {
  STR: 'Strength', DEX: 'Dexterity', CON: 'Constitution',
  INT: 'Intelligence', WIS: 'Wisdom', CHA: 'Charisma',
};
---

<BaseLayout title="Character Creation">
  <div class="page-container">
    <div class="back-link"><a href={`${base}/characters`}>&larr; The Party</a></div>
    <h1>Character Creation</h1>
    <p class="intro-text">Build a new character step by step. Choose your race, class, ability scores, and background.</p>

    <!-- Step Indicator -->
    <div class="step-bar">
      {['Race', 'Class', 'Abilities', 'Background', 'Review'].map((label, i) => (
        <div class={`step-item ${i === 0 ? 'active' : ''}`} data-step-indicator={i}>
          <span class="step-num">{i + 1}</span>
          <span class="step-label">{label}</span>
        </div>
      ))}
    </div>

    <!-- ═══════════ STEP 1: RACE ═══════════ -->
    <div class="step-panel active" data-step="0">
      <h2>Choose Your Race</h2>
      <p class="step-desc">Select a race for your character. Each race provides ability score increases, languages, and unique racial traits.</p>

      <div class="card-grid" id="race-grid">
        {races.map(race => (
          <button class="choice-card" data-race={race.slug}>
            <div class="choice-header">
              <h3>{race.name}</h3>
              <span class="choice-badge">{race.source}</span>
            </div>
            <p class="choice-stats">
              <span class="stat-tag">{race.abilityScoreIncrease}</span>
              <span class="stat-tag">Speed {race.speed} ft</span>
              <span class="stat-tag">{race.size}</span>
            </p>
            <p class="choice-desc">{race.description}</p>
          </button>
        ))}
      </div>

      <!-- Subrace picker (shown conditionally) -->
      <div id="subrace-section" class="subsection" style="display:none;">
        <h3>Choose Your Subrace</h3>
        <div class="card-grid" id="subrace-grid"></div>
      </div>

      <div class="step-actions">
        <button class="btn btn-primary" id="next-1" disabled>Next: Choose Class &rarr;</button>
      </div>
    </div>

    <!-- ═══════════ STEP 2: CLASS ═══════════ -->
    <div class="step-panel" data-step="1">
      <h2>Choose Your Class</h2>
      <p class="step-desc">Your class determines your abilities, hit points, proficiencies, and features as you level up.</p>

      <div class="card-grid" id="class-grid">
        {classesData.map(cls => (
          <button class="choice-card" data-class={cls.slug}>
            <div class="choice-header">
              <h3>{cls.name}</h3>
              <span class="choice-badge">d{cls.hitDie}</span>
            </div>
            <p class="choice-stats">
              <span class="stat-tag">{cls.primaryAbility}</span>
              <span class="stat-tag">Saves: {cls.savingThrows}</span>
            </p>
            <p class="choice-desc">{cls.description}</p>
          </button>
        ))}
      </div>

      <div class="step-actions">
        <button class="btn btn-muted" id="back-2">&larr; Back</button>
        <button class="btn btn-primary" id="next-2" disabled>Next: Ability Scores &rarr;</button>
      </div>
    </div>

    <!-- ═══════════ STEP 3: ABILITY SCORES ═══════════ -->
    <div class="step-panel" data-step="2">
      <h2>Assign Ability Scores</h2>
      <p class="step-desc">Use the Standard Array (15, 14, 13, 12, 10, 8) or Point Buy to assign your ability scores. Racial bonuses are applied automatically.</p>

      <div class="method-toggle">
        <button class="method-btn active" data-method="standard">Standard Array</button>
        <button class="method-btn" data-method="pointbuy">Point Buy</button>
      </div>

      <!-- Standard Array Mode -->
      <div id="standard-mode" class="ability-mode">
        <p class="mode-help">Click an ability, then click a value from the array to assign it.</p>
        <div class="array-pool" id="array-pool">
          {standardArray.map(val => (
            <button class="pool-value" data-value={val}>{val}</button>
          ))}
        </div>
      </div>

      <!-- Point Buy Mode -->
      <div id="pointbuy-mode" class="ability-mode" style="display:none;">
        <p class="mode-help">Spend 27 points. Scores start at 8. Cost: 8→9 = 1pt, 9→10 = 1pt, ... 13→14 = 2pts, 14→15 = 2pts.</p>
        <div class="points-remaining">Points: <span id="points-left">27</span> / 27</div>
      </div>

      <div class="abilities-grid">
        {abilities.map(ab => (
          <div class="ability-box" data-ability={ab}>
            <div class="ability-name">{abilityFull[ab]}</div>
            <div class="ability-controls">
              <button class="ab-minus" data-ab={ab} style="display:none;">−</button>
              <span class="ability-base" data-ab-base={ab}>—</span>
              <button class="ab-plus" data-ab={ab} style="display:none;">+</button>
            </div>
            <div class="ability-racial" data-ab-racial={ab}></div>
            <div class="ability-total">
              <span class="total-score" data-ab-total={ab}>—</span>
              <span class="total-mod" data-ab-mod={ab}></span>
            </div>
          </div>
        ))}
      </div>

      <div class="step-actions">
        <button class="btn btn-muted" id="back-3">&larr; Back</button>
        <button class="btn btn-primary" id="next-3" disabled>Next: Background &rarr;</button>
      </div>
    </div>

    <!-- ═══════════ STEP 4: BACKGROUND ═══════════ -->
    <div class="step-panel" data-step="3">
      <h2>Choose Your Background</h2>
      <p class="step-desc">Your background describes where you came from and gives you skill proficiencies, tool proficiencies, languages, and a special feature.</p>

      <div class="card-grid" id="bg-grid">
        {backgrounds.map(bg => (
          <button class="choice-card" data-bg={bg.slug}>
            <div class="choice-header">
              <h3>{bg.name}</h3>
              <span class="choice-badge">{bg.source}</span>
            </div>
            <p class="choice-stats">
              <span class="stat-tag">Skills: {bg.skillProficiencies}</span>
              {bg.toolProficiencies !== 'None' && <span class="stat-tag">Tools: {bg.toolProficiencies}</span>}
              {bg.languages !== 'None' && <span class="stat-tag">Languages: {bg.languages}</span>}
            </p>
            <p class="choice-desc">{bg.description}</p>
          </button>
        ))}
      </div>

      <div class="step-actions">
        <button class="btn btn-muted" id="back-4">&larr; Back</button>
        <button class="btn btn-primary" id="next-4" disabled>Review Character &rarr;</button>
      </div>
    </div>

    <!-- ═══════════ STEP 5: REVIEW ═══════════ -->
    <div class="step-panel" data-step="4">
      <h2>Review Your Character</h2>

      <div class="review-header">
        <input type="text" id="char-name" placeholder="Enter character name..." class="name-input" />
      </div>

      <div class="review-grid">
        <div class="review-section">
          <h3>Race & Class</h3>
          <div class="review-row"><span class="review-label">Race:</span> <span id="review-race">—</span></div>
          <div class="review-row"><span class="review-label">Subrace:</span> <span id="review-subrace">—</span></div>
          <div class="review-row"><span class="review-label">Class:</span> <span id="review-class">—</span></div>
          <div class="review-row"><span class="review-label">Hit Die:</span> <span id="review-hitdie">—</span></div>
          <div class="review-row"><span class="review-label">Background:</span> <span id="review-bg">—</span></div>
        </div>

        <div class="review-section">
          <h3>Ability Scores</h3>
          <div class="review-abilities" id="review-abilities"></div>
        </div>

        <div class="review-section">
          <h3>Proficiencies</h3>
          <div class="review-row"><span class="review-label">Saving Throws:</span> <span id="review-saves">—</span></div>
          <div class="review-row"><span class="review-label">Skills:</span> <span id="review-skills">—</span></div>
          <div class="review-row"><span class="review-label">Armor:</span> <span id="review-armor">—</span></div>
          <div class="review-row"><span class="review-label">Weapons:</span> <span id="review-weapons">—</span></div>
          <div class="review-row"><span class="review-label">Tools:</span> <span id="review-tools">—</span></div>
          <div class="review-row"><span class="review-label">Languages:</span> <span id="review-languages">—</span></div>
        </div>

        <div class="review-section">
          <h3>Racial Traits</h3>
          <div id="review-traits"></div>
        </div>

        <div class="review-section">
          <h3>Background Feature</h3>
          <div id="review-feature"></div>
        </div>

        <div class="review-section">
          <h3>Combat Stats</h3>
          <div class="review-row"><span class="review-label">HP:</span> <span id="review-hp">—</span></div>
          <div class="review-row"><span class="review-label">AC:</span> <span id="review-ac">—</span></div>
          <div class="review-row"><span class="review-label">Initiative:</span> <span id="review-init">—</span></div>
          <div class="review-row"><span class="review-label">Speed:</span> <span id="review-speed">—</span></div>
        </div>
      </div>

      <div class="step-actions">
        <button class="btn btn-muted" id="back-5">&larr; Back</button>
        <button class="btn btn-accent" id="download-char">Download Character (.md)</button>
        <button class="btn btn-muted" id="start-over">Start Over</button>
      </div>
    </div>
  </div>
</BaseLayout>

<!-- Inject data for client-side use -->
<script define:vars={{ raceData, classData, bgData, skillData }}>
  window.__RACES__ = JSON.parse(raceData);
  window.__CLASSES__ = JSON.parse(classData);
  window.__BACKGROUNDS__ = JSON.parse(bgData);
  window.__SKILLS__ = JSON.parse(skillData);
</script>

<script>
  // ═══════════════════════════════════════════════════════
  // Character Creation State Machine
  // ═══════════════════════════════════════════════════════

  const RACES = (window as any).__RACES__;
  const CLASSES = (window as any).__CLASSES__;
  const BGS = (window as any).__BACKGROUNDS__;

  interface CharState {
    race: any | null;
    subrace: any | null;
    cls: any | null;
    background: any | null;
    abilityMethod: 'standard' | 'pointbuy';
    baseScores: Record<string, number>;
    name: string;
  }

  const state: CharState = {
    race: null,
    subrace: null,
    cls: null,
    background: null,
    abilityMethod: 'standard',
    baseScores: { STR: 0, DEX: 0, CON: 0, INT: 0, WIS: 0, CHA: 0 },
    name: '',
  };

  let currentStep = 0;
  let selectedArraySlot: string | null = null;

  const ABILITIES = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];
  const STANDARD_ARRAY = [15, 14, 13, 12, 10, 8];
  const POINT_BUY_COSTS: Record<number, number> = {
    8: 0, 9: 1, 10: 2, 11: 3, 12: 4, 13: 5, 14: 7, 15: 9,
  };

  // ── Step Navigation ──
  function goToStep(step: number) {
    document.querySelectorAll('.step-panel').forEach((p, i) => {
      (p as HTMLElement).classList.toggle('active', i === step);
    });
    document.querySelectorAll('.step-item').forEach((s, i) => {
      s.classList.toggle('active', i === step);
      s.classList.toggle('completed', i < step);
    });
    currentStep = step;
    if (step === 4) populateReview();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // ── STEP 1: Race Selection ──
  document.querySelectorAll('#race-grid .choice-card').forEach(card => {
    card.addEventListener('click', () => {
      document.querySelectorAll('#race-grid .choice-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      const slug = (card as HTMLElement).dataset.race;
      state.race = RACES.find((r: any) => r.slug === slug) || null;
      state.subrace = null;

      const subraceSection = document.getElementById('subrace-section')!;
      const subraceGrid = document.getElementById('subrace-grid')!;

      if (state.race && state.race.subraces.length > 0) {
        subraceGrid.innerHTML = state.race.subraces.map((sr: any) => `
          <button class="choice-card subrace-card" data-subrace="${sr.slug}">
            <div class="choice-header">
              <h3>${sr.name}</h3>
              <span class="choice-badge">${sr.abilityScoreIncrease}</span>
            </div>
            <p class="choice-desc">${sr.traits.map((t: any) => `<strong>${t.name}:</strong> ${t.description}`).join('<br/>')}</p>
          </button>
        `).join('');
        subraceSection.style.display = '';
        // Attach subrace click handlers
        subraceGrid.querySelectorAll('.subrace-card').forEach(sc => {
          sc.addEventListener('click', () => {
            subraceGrid.querySelectorAll('.subrace-card').forEach(c => c.classList.remove('selected'));
            sc.classList.add('selected');
            const srSlug = (sc as HTMLElement).dataset.subrace;
            state.subrace = state.race.subraces.find((s: any) => s.slug === srSlug) || null;
            (document.getElementById('next-1') as HTMLButtonElement).disabled = false;
          });
        });
        (document.getElementById('next-1') as HTMLButtonElement).disabled = true;
      } else {
        subraceSection.style.display = 'none';
        (document.getElementById('next-1') as HTMLButtonElement).disabled = false;
      }
    });
  });

  document.getElementById('next-1')?.addEventListener('click', () => goToStep(1));

  // ── STEP 2: Class Selection ──
  document.querySelectorAll('#class-grid .choice-card').forEach(card => {
    card.addEventListener('click', () => {
      document.querySelectorAll('#class-grid .choice-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      const slug = (card as HTMLElement).dataset.class;
      state.cls = CLASSES.find((c: any) => c.slug === slug) || null;
      (document.getElementById('next-2') as HTMLButtonElement).disabled = false;
    });
  });

  document.getElementById('back-2')?.addEventListener('click', () => goToStep(0));
  document.getElementById('next-2')?.addEventListener('click', () => {
    resetAbilities();
    goToStep(2);
  });

  // ── STEP 3: Ability Scores ──
  function resetAbilities() {
    ABILITIES.forEach(ab => {
      state.baseScores[ab] = state.abilityMethod === 'pointbuy' ? 8 : 0;
    });
    selectedArraySlot = null;
    updateAbilityDisplay();
    // Reset pool buttons
    document.querySelectorAll('.pool-value').forEach(btn => {
      (btn as HTMLElement).classList.remove('used');
    });
  }

  function parseRacialBonuses(): Record<string, number> {
    const bonuses: Record<string, number> = {};
    if (!state.race) return bonuses;

    const parseStr = (str: string) => {
      // Parse strings like "+2 Strength, +1 Constitution"
      const parts = str.split(',');
      parts.forEach(p => {
        const match = p.trim().match(/\+(\d+)\s+(Strength|Dexterity|Constitution|Intelligence|Wisdom|Charisma|STR|DEX|CON|INT|WIS|CHA|all ability scores)/i);
        if (match) {
          const val = parseInt(match[1]);
          const ab = match[2].toLowerCase();
          const map: Record<string, string> = {
            strength: 'STR', dexterity: 'DEX', constitution: 'CON',
            intelligence: 'INT', wisdom: 'WIS', charisma: 'CHA',
            str: 'STR', dex: 'DEX', con: 'CON', int: 'INT', wis: 'WIS', cha: 'CHA',
          };
          if (ab === 'all ability scores') {
            ABILITIES.forEach(a => bonuses[a] = (bonuses[a] || 0) + val);
          } else if (map[ab]) {
            bonuses[map[ab]] = (bonuses[map[ab]] || 0) + val;
          }
        }
      });
    };

    parseStr(state.race.abilityScoreIncrease);
    if (state.subrace && state.subrace.abilityScoreIncrease && !state.subrace.abilityScoreIncrease.includes('included')) {
      parseStr(state.subrace.abilityScoreIncrease);
    }
    return bonuses;
  }

  function modStr(score: number): string {
    const m = Math.floor((score - 10) / 2);
    return m >= 0 ? `+${m}` : `${m}`;
  }

  function updateAbilityDisplay() {
    const racial = parseRacialBonuses();
    let allAssigned = true;

    ABILITIES.forEach(ab => {
      const baseEl = document.querySelector(`[data-ab-base="${ab}"]`)!;
      const racialEl = document.querySelector(`[data-ab-racial="${ab}"]`)!;
      const totalEl = document.querySelector(`[data-ab-total="${ab}"]`)!;
      const modEl = document.querySelector(`[data-ab-mod="${ab}"]`)!;
      const base = state.baseScores[ab];
      const racialBonus = racial[ab] || 0;

      if (base === 0 && state.abilityMethod === 'standard') {
        baseEl.textContent = '—';
        totalEl.textContent = '—';
        modEl.textContent = '';
        allAssigned = false;
      } else {
        baseEl.textContent = String(base);
        const total = base + racialBonus;
        totalEl.textContent = String(total);
        modEl.textContent = `(${modStr(total)})`;
      }

      racialEl.textContent = racialBonus ? `+${racialBonus} racial` : '';
    });

    // Point buy mode — update points
    if (state.abilityMethod === 'pointbuy') {
      let spent = 0;
      ABILITIES.forEach(ab => { spent += POINT_BUY_COSTS[state.baseScores[ab]] || 0; });
      const left = 27 - spent;
      document.getElementById('points-left')!.textContent = String(left);
      allAssigned = left >= 0 && ABILITIES.every(ab => state.baseScores[ab] >= 8);
    }

    (document.getElementById('next-3') as HTMLButtonElement).disabled = !allAssigned;
  }

  // Standard Array: click ability box to select slot, then click pool value to assign
  document.querySelectorAll('.ability-box').forEach(box => {
    box.addEventListener('click', () => {
      if (state.abilityMethod !== 'standard') return;
      document.querySelectorAll('.ability-box').forEach(b => b.classList.remove('selecting'));
      box.classList.add('selecting');
      selectedArraySlot = (box as HTMLElement).dataset.ability || null;
    });
  });

  document.querySelectorAll('.pool-value').forEach(btn => {
    btn.addEventListener('click', () => {
      if (!selectedArraySlot || (btn as HTMLElement).classList.contains('used')) return;
      const val = parseInt((btn as HTMLElement).dataset.value!);
      // Un-assign previous value from this slot if any
      const prev = state.baseScores[selectedArraySlot];
      if (prev > 0) {
        document.querySelectorAll('.pool-value').forEach(pb => {
          if (parseInt((pb as HTMLElement).dataset.value!) === prev && (pb as HTMLElement).classList.contains('used')) {
            // Only un-use one instance
            let found = false;
            document.querySelectorAll('.pool-value.used').forEach(u => {
              if (!found && parseInt((u as HTMLElement).dataset.value!) === prev) {
                u.classList.remove('used');
                found = true;
              }
            });
          }
        });
      }
      state.baseScores[selectedArraySlot] = val;
      (btn as HTMLElement).classList.add('used');
      document.querySelectorAll('.ability-box').forEach(b => b.classList.remove('selecting'));
      selectedArraySlot = null;
      updateAbilityDisplay();
    });
  });

  // Point Buy: +/- buttons
  document.querySelectorAll('.ab-plus').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const ab = (btn as HTMLElement).dataset.ab!;
      if (state.baseScores[ab] < 15) {
        const next = state.baseScores[ab] + 1;
        const cost = (POINT_BUY_COSTS[next] || 0) - (POINT_BUY_COSTS[state.baseScores[ab]] || 0);
        let spent = 0;
        ABILITIES.forEach(a => { spent += POINT_BUY_COSTS[state.baseScores[a]] || 0; });
        if (spent + cost <= 27) {
          state.baseScores[ab] = next;
          updateAbilityDisplay();
        }
      }
    });
  });

  document.querySelectorAll('.ab-minus').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const ab = (btn as HTMLElement).dataset.ab!;
      if (state.baseScores[ab] > 8) {
        state.baseScores[ab]--;
        updateAbilityDisplay();
      }
    });
  });

  // Method toggle
  document.querySelectorAll('.method-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.method-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const method = (btn as HTMLElement).dataset.method as 'standard' | 'pointbuy';
      state.abilityMethod = method;
      document.getElementById('standard-mode')!.style.display = method === 'standard' ? '' : 'none';
      document.getElementById('pointbuy-mode')!.style.display = method === 'pointbuy' ? '' : 'none';
      // Show/hide +/- buttons
      document.querySelectorAll('.ab-plus, .ab-minus').forEach(b => {
        (b as HTMLElement).style.display = method === 'pointbuy' ? '' : 'none';
      });
      resetAbilities();
    });
  });

  document.getElementById('back-3')?.addEventListener('click', () => goToStep(1));
  document.getElementById('next-3')?.addEventListener('click', () => goToStep(3));

  // ── STEP 4: Background ──
  document.querySelectorAll('#bg-grid .choice-card').forEach(card => {
    card.addEventListener('click', () => {
      document.querySelectorAll('#bg-grid .choice-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      const slug = (card as HTMLElement).dataset.bg;
      state.background = BGS.find((b: any) => b.slug === slug) || null;
      (document.getElementById('next-4') as HTMLButtonElement).disabled = false;
    });
  });

  document.getElementById('back-4')?.addEventListener('click', () => goToStep(2));
  document.getElementById('next-4')?.addEventListener('click', () => goToStep(4));

  // ── STEP 5: Review ──
  function populateReview() {
    const racial = parseRacialBonuses();

    document.getElementById('review-race')!.textContent = state.race?.name || '—';
    document.getElementById('review-subrace')!.textContent = state.subrace?.name || 'None';
    document.getElementById('review-class')!.textContent = state.cls?.name || '—';
    document.getElementById('review-hitdie')!.textContent = state.cls ? `d${state.cls.hitDie}` : '—';
    document.getElementById('review-bg')!.textContent = state.background?.name || '—';

    // Abilities
    const abEl = document.getElementById('review-abilities')!;
    abEl.innerHTML = ABILITIES.map(ab => {
      const base = state.baseScores[ab];
      const bonus = racial[ab] || 0;
      const total = base + bonus;
      return `<div class="review-ability"><strong>${ab}</strong> <span class="review-ab-score">${total}</span> <span class="review-ab-mod">(${modStr(total)})</span></div>`;
    }).join('');

    // Proficiencies
    document.getElementById('review-saves')!.textContent = state.cls?.savingThrows || '—';
    const bgSkills = state.background?.skillProficiencies || '';
    document.getElementById('review-skills')!.textContent = bgSkills + (state.cls?.skillChoices ? ` + ${state.cls.skillChoices}` : '');
    document.getElementById('review-armor')!.textContent = state.cls?.armorProficiencies || 'None';
    document.getElementById('review-weapons')!.textContent = state.cls?.weaponProficiencies || 'None';

    const tools: string[] = [];
    if (state.cls?.toolProficiencies && state.cls.toolProficiencies !== 'None') tools.push(state.cls.toolProficiencies);
    if (state.background?.toolProficiencies && state.background.toolProficiencies !== 'None') tools.push(state.background.toolProficiencies);
    document.getElementById('review-tools')!.textContent = tools.length ? tools.join(', ') : 'None';

    const langs: string[] = [];
    if (state.race?.languages) langs.push(state.race.languages);
    if (state.background?.languages && state.background.languages !== 'None') langs.push(state.background.languages);
    document.getElementById('review-languages')!.textContent = langs.join(', ') || '—';

    // Racial traits
    const traitsEl = document.getElementById('review-traits')!;
    const allTraits = [...(state.race?.traits || []), ...(state.subrace?.traits || [])];
    traitsEl.innerHTML = allTraits.map((t: any) => `<div class="review-trait"><strong>${t.name}:</strong> ${t.description}</div>`).join('');

    // Background feature
    const featEl = document.getElementById('review-feature')!;
    if (state.background?.feature) {
      featEl.innerHTML = `<div class="review-trait"><strong>${state.background.feature.name}:</strong> ${state.background.feature.description}</div>`;
    }

    // Combat stats
    const conMod = Math.floor(((state.baseScores.CON + (racial.CON || 0)) - 10) / 2);
    const dexMod = Math.floor(((state.baseScores.DEX + (racial.DEX || 0)) - 10) / 2);
    const hp = (state.cls?.hitDie || 8) + conMod;
    document.getElementById('review-hp')!.textContent = `${hp} (${state.cls?.hitDie || 8} + ${conMod} CON)`;
    document.getElementById('review-ac')!.textContent = `${10 + dexMod} (unarmored)`;
    document.getElementById('review-init')!.textContent = `${dexMod >= 0 ? '+' : ''}${dexMod}`;
    document.getElementById('review-speed')!.textContent = `${state.race?.speed || 30} ft`;
  }

  document.getElementById('back-5')?.addEventListener('click', () => goToStep(3));

  // Download as .md file
  document.getElementById('download-char')?.addEventListener('click', () => {
    const name = (document.getElementById('char-name') as HTMLInputElement).value.trim() || 'New Character';
    state.name = name;
    const racial = parseRacialBonuses();
    const conMod = Math.floor(((state.baseScores.CON + (racial.CON || 0)) - 10) / 2);
    const hp = (state.cls?.hitDie || 8) + conMod;

    const md = `---
name: "${name}"
race: "${state.race?.name || ''}"
subrace: "${state.subrace?.name || ''}"
class: "${state.cls?.name || ''}"
level: 1
background: "${state.background?.name || ''}"
status: "active"
hp: ${hp}
maxHp: ${hp}
ac: ${10 + Math.floor(((state.baseScores.DEX + (racial.DEX || 0)) - 10) / 2)}
speed: ${state.race?.speed || 30}
abilityScores:
  str: ${state.baseScores.STR + (racial.STR || 0)}
  dex: ${state.baseScores.DEX + (racial.DEX || 0)}
  con: ${state.baseScores.CON + (racial.CON || 0)}
  int: ${state.baseScores.INT + (racial.INT || 0)}
  wis: ${state.baseScores.WIS + (racial.WIS || 0)}
  cha: ${state.baseScores.CHA + (racial.CHA || 0)}
savingThrows: "${state.cls?.savingThrows || ''}"
hitDie: "d${state.cls?.hitDie || 8}"
currency:
  pp: 0
  gp: 0
  ep: 0
  sp: 0
  cp: 0
inventory: []
equipped: {}
spells: []
spellSlots: {}
conditions: []
levelHistory: []
---

# ${name}

A ${state.race?.name || ''} ${state.cls?.name || ''} with the ${state.background?.name || ''} background.
`;
    const blob = new Blob([md], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${name.toLowerCase().replace(/[^a-z0-9]+/g, '-')}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // Start Over
  document.getElementById('start-over')?.addEventListener('click', () => {
    state.race = null;
    state.subrace = null;
    state.cls = null;
    state.background = null;
    state.name = '';
    ABILITIES.forEach(ab => state.baseScores[ab] = 0);
    document.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));
    document.querySelectorAll('.pool-value').forEach(b => b.classList.remove('used'));
    ['next-1', 'next-2', 'next-3', 'next-4'].forEach(id => {
      (document.getElementById(id) as HTMLButtonElement).disabled = true;
    });
    (document.getElementById('char-name') as HTMLInputElement).value = '';
    goToStep(0);
  });
</script>

<style>
/* Step Bar */
.step-bar {
  display: flex;
  gap: 0.25rem;
  margin-bottom: 2rem;
  padding: 0.75rem;
  background: rgba(0,201,167,0.04);
  border: 1px solid rgba(0,201,167,0.15);
  border-radius: 8px;
  overflow-x: auto;
}
.step-item {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.4rem 0.8rem;
  border-radius: 6px;
  font-size: 0.78rem;
  color: var(--text-muted);
  white-space: nowrap;
  transition: all 0.2s ease;
  flex: 1;
  justify-content: center;
}
.step-item.active {
  background: rgba(0,201,167,0.15);
  color: var(--accent-primary);
  font-weight: 600;
}
.step-item.completed {
  color: var(--accent-primary);
  opacity: 0.7;
}
.step-num {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 1.4rem;
  height: 1.4rem;
  border-radius: 50%;
  border: 1px solid currentColor;
  font-size: 0.68rem;
  font-weight: 700;
}
.step-item.active .step-num {
  background: var(--accent-primary);
  color: var(--bg-body);
  border-color: var(--accent-primary);
}
.step-item.completed .step-num {
  background: var(--accent-primary);
  color: var(--bg-body);
  border-color: var(--accent-primary);
}
.step-label { font-size: 0.72rem; }

/* Step Panels */
.step-panel { display: none; }
.step-panel.active { display: block; }
.step-desc { color: var(--text-muted); font-size: 0.88rem; margin-bottom: 1.5rem; }

/* Card Grid */
.card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 0.75rem;
  margin-bottom: 1.5rem;
}
.choice-card {
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
  padding: 1rem;
  background: var(--bg-card);
  border: 2px solid var(--border-subtle);
  border-radius: 8px;
  cursor: pointer;
  text-align: left;
  transition: all 0.15s ease;
  color: var(--text-normal);
  font-family: inherit;
  font-size: inherit;
}
.choice-card:hover {
  border-color: rgba(0,201,167,0.4);
  background: var(--bg-card-hover);
}
.choice-card.selected {
  border-color: var(--accent-primary);
  background: rgba(0,201,167,0.08);
  box-shadow: 0 0 12px rgba(0,201,167,0.15);
}
.choice-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.choice-header h3 {
  margin: 0;
  font-size: 1rem;
  color: var(--text-bright);
}
.choice-badge {
  font-size: 0.62rem;
  background: rgba(0,201,167,0.15);
  color: var(--accent-primary);
  padding: 0.15rem 0.4rem;
  border-radius: 4px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-weight: 600;
}
.choice-stats {
  display: flex;
  gap: 0.4rem;
  flex-wrap: wrap;
  margin: 0;
}
.stat-tag {
  font-size: 0.68rem;
  color: var(--text-muted);
  background: rgba(255,255,255,0.04);
  padding: 0.1rem 0.4rem;
  border-radius: 3px;
}
.choice-desc {
  font-size: 0.78rem;
  color: var(--text-dim);
  line-height: 1.45;
  margin: 0;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Subsection */
.subsection {
  margin-top: 1.5rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-subtle);
}
.subsection h3 { margin-bottom: 0.75rem; }

/* Step Actions */
.step-actions {
  display: flex;
  gap: 0.75rem;
  margin-top: 2rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--border-subtle);
}

/* Buttons */
.btn {
  padding: 0.6rem 1.2rem;
  border: 1px solid transparent;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s ease;
  font-family: inherit;
}
.btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
.btn-primary {
  background: var(--accent-primary);
  color: var(--bg-body);
  border-color: var(--accent-primary);
}
.btn-primary:hover:not(:disabled) { filter: brightness(1.1); }
.btn-secondary {
  background: rgba(0,201,167,0.15);
  color: var(--accent-primary);
  border-color: rgba(0,201,167,0.3);
}
.btn-accent {
  background: linear-gradient(135deg, var(--accent-primary), #00a67d);
  color: var(--bg-body);
  font-weight: 600;
}
.btn-accent:hover { filter: brightness(1.1); }
.btn-muted {
  background: rgba(255,255,255,0.05);
  color: var(--text-muted);
  border-color: var(--border-subtle);
}
.btn-muted:hover { background: rgba(255,255,255,0.1); }

/* ── Ability Scores ── */
.method-toggle {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}
.method-btn {
  padding: 0.4rem 1rem;
  border: 1px solid var(--border-subtle);
  border-radius: 6px;
  background: var(--bg-card);
  color: var(--text-muted);
  cursor: pointer;
  font-family: inherit;
  font-size: 0.82rem;
  transition: all 0.15s ease;
}
.method-btn.active {
  background: rgba(0,201,167,0.15);
  color: var(--accent-primary);
  border-color: var(--accent-primary);
}

.ability-mode { margin-bottom: 1.5rem; }
.mode-help { font-size: 0.78rem; color: var(--text-dim); margin-bottom: 0.75rem; }

.array-pool {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.pool-value {
  padding: 0.5rem 1rem;
  font-size: 1.1rem;
  font-weight: 700;
  background: var(--bg-card);
  border: 2px solid rgba(0,201,167,0.3);
  border-radius: 8px;
  color: var(--text-bright);
  cursor: pointer;
  transition: all 0.15s ease;
  font-family: inherit;
}
.pool-value:hover:not(.used) { border-color: var(--accent-primary); }
.pool-value.used {
  opacity: 0.3;
  text-decoration: line-through;
  cursor: not-allowed;
}

.points-remaining {
  font-size: 1rem;
  font-weight: 600;
  color: var(--accent-primary);
  margin-bottom: 1rem;
}

.abilities-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 0.75rem;
}
.ability-box {
  padding: 1rem;
  background: var(--bg-card);
  border: 2px solid var(--border-subtle);
  border-radius: 8px;
  text-align: center;
  cursor: pointer;
  transition: all 0.15s ease;
}
.ability-box:hover { border-color: rgba(0,201,167,0.3); }
.ability-box.selecting {
  border-color: var(--accent-primary);
  box-shadow: 0 0 12px rgba(0,201,167,0.2);
}
.ability-name {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  margin-bottom: 0.5rem;
  font-weight: 600;
}
.ability-controls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}
.ab-minus, .ab-plus {
  width: 1.8rem;
  height: 1.8rem;
  border: 1px solid var(--border-subtle);
  border-radius: 4px;
  background: var(--bg-card);
  color: var(--text-normal);
  cursor: pointer;
  font-size: 1rem;
  font-family: inherit;
  display: flex;
  align-items: center;
  justify-content: center;
}
.ab-minus:hover, .ab-plus:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
.ability-base {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-bright);
  min-width: 2rem;
  display: inline-block;
}
.ability-racial {
  font-size: 0.68rem;
  color: var(--accent-primary);
  margin-top: 0.25rem;
  min-height: 1em;
}
.ability-total {
  margin-top: 0.5rem;
  padding-top: 0.5rem;
  border-top: 1px solid var(--border-subtle);
}
.total-score {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--accent-primary);
}
.total-mod {
  font-size: 0.78rem;
  color: var(--text-muted);
  margin-left: 0.25rem;
}

/* ── Review ── */
.name-input {
  width: 100%;
  padding: 0.75rem 1rem;
  font-size: 1.4rem;
  font-family: 'Cinzel', serif;
  background: var(--bg-card);
  border: 2px solid var(--border-subtle);
  border-radius: 8px;
  color: var(--text-bright);
  margin-bottom: 1.5rem;
}
.name-input:focus {
  outline: none;
  border-color: var(--accent-primary);
}
.name-input::placeholder {
  color: var(--text-dim);
}

.review-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 1rem;
}
.review-section {
  padding: 1rem;
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: 8px;
}
.review-section h3 {
  font-size: 0.82rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--accent-primary);
  margin: 0 0 0.75rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid var(--border-subtle);
}
.review-row {
  font-size: 0.85rem;
  margin-bottom: 0.4rem;
  color: var(--text-normal);
}
.review-label {
  color: var(--text-muted);
  font-weight: 600;
  margin-right: 0.3rem;
}
.review-abilities {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.5rem;
}
.review-ability {
  text-align: center;
  padding: 0.5rem;
  background: rgba(0,0,0,0.2);
  border-radius: 6px;
}
.review-ability strong {
  display: block;
  font-size: 0.68rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.review-ab-score {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--text-bright);
}
.review-ab-mod {
  font-size: 0.78rem;
  color: var(--accent-primary);
}
.review-trait {
  font-size: 0.82rem;
  margin-bottom: 0.5rem;
  color: var(--text-normal);
  line-height: 1.45;
}
.review-trait strong {
  color: var(--text-bright);
}

/* Responsive */
@media (max-width: 640px) {
  .step-bar { flex-direction: column; }
  .card-grid { grid-template-columns: 1fr; }
  .abilities-grid { grid-template-columns: repeat(2, 1fr); }
  .review-grid { grid-template-columns: 1fr; }
  .review-abilities { grid-template-columns: repeat(3, 1fr); }
}

.intro-text {
  color: var(--text-muted);
  font-size: 0.88rem;
  margin-bottom: 1.5rem;
}
</style>
