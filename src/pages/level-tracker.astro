---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const characters = await getCollection('characters');
const active = characters
  .filter(c => c.data.status !== 'inactive')
  .sort((a, b) => (a.data.name ?? '').localeCompare(b.data.name ?? ''));

const currentLevel = active[0]?.data?.level ?? 1;

// XP thresholds by level (D&D 5e)
const xpThresholds: Record<number, number> = {
  1: 0, 2: 300, 3: 900, 4: 2700, 5: 6500, 6: 14000,
  7: 23000, 8: 34000, 9: 48000, 10: 64000,
};
const nextLevelXP = xpThresholds[currentLevel + 1] ?? null;

// Proficiency bonus by level
function profBonus(level: number): string {
  if (level <= 4) return '+2';
  if (level <= 8) return '+3';
  if (level <= 12) return '+4';
  return '+5';
}
---

<BaseLayout title="Level Tracker">
  <div class="page-container">
    <div class="back-link"><a href="/characters">← The Party</a></div>

    <div class="section-header">
      <h1>Level Tracker</h1>
      <p class="intro-text">Current party level: <strong class="gold">{currentLevel}</strong> — Prof Bonus {profBonus(currentLevel)}</p>
    </div>

    {nextLevelXP && (
      <div class="next-level-bar">
        <div class="nlb-label">
          <span>Next milestone: <strong>Level {currentLevel + 1}</strong></span>
          <span class="nlb-xp">{nextLevelXP.toLocaleString()} XP needed</span>
        </div>
        <p class="nlb-note">When the party reaches this XP threshold, update each character's <code>level</code> and <code>maxHp</code> in their frontmatter.</p>
      </div>
    )}

    <!-- Character level cards -->
    <div class="char-level-grid">
      {active.map(c => {
        const d = c.data;
        const history = d.levelHistory ?? [];
        const pendingLevelUp = (d.level ?? 1) < currentLevel;
        return (
          <div class={`char-level-card ${pendingLevelUp ? 'card-pending' : ''}`}>
            <div class="clc-header">
              <div class="clc-name-row">
                <a href={`/characters/${c.slug}`} class="clc-name">{d.name}</a>
                {d.player && <span class="clc-player">{d.player}</span>}
              </div>
              <div class="clc-class-row">
                <span class="clc-class">{d.class}</span>
                {d.subclass && <span class="clc-subclass">({d.subclass})</span>}
              </div>
            </div>

            <div class="clc-stats">
              <div class="clc-stat">
                <span class="stat-val">{d.level ?? 1}</span>
                <span class="stat-lbl">Level</span>
              </div>
              <div class="clc-stat">
                <span class="stat-val">{d.maxHp ?? d.hp ?? '?'}</span>
                <span class="stat-lbl">Max HP</span>
              </div>
              <div class="clc-stat">
                <span class="stat-val">{profBonus(d.level ?? 1)}</span>
                <span class="stat-lbl">Prof</span>
              </div>
            </div>

            {pendingLevelUp && (
              <div class="pending-warning">
                ⚠️ Level data may need updating
              </div>
            )}

            {history.length > 0 && (
              <div class="level-history">
                <div class="history-label">Level History</div>
                {history.map(entry => (
                  <div class="history-row">
                    <span class="history-level">Lvl {entry.level}</span>
                    {entry.sessionNumber && <span class="history-session">Session {entry.sessionNumber}</span>}
                    {entry.hpGained && <span class="history-hp">+{entry.hpGained} HP</span>}
                    {entry.features && entry.features.length > 0 && (
                      <ul class="history-features">
                        {entry.features.map(f => <li>{f}</li>)}
                      </ul>
                    )}
                    {entry.notes && <p class="history-notes">{entry.notes}</p>}
                  </div>
                ))}
              </div>
            )}

            {history.length === 0 && (
              <div class="no-history">
                No level-up history yet. Add a <code>levelHistory</code> array to this character's frontmatter.
              </div>
            )}
          </div>
        );
      })}
    </div>

    <hr />

    <!-- How to record a level up -->
    <div class="howto-section">
      <h2>How to Record a Level-Up</h2>
      <p>When the party levels up, add an entry to the character's <code>.md</code> frontmatter:</p>
      <pre class="code-block">{`levelHistory:
  - level: 2
    sessionNumber: 3
    hpGained: 6
    features:
      - "Cunning Action (Dash, Disengage, or Hide as bonus action)"
      - "Expertise (2 more skills)"
    notes: "Took Arcane Trickster track"`}</pre>
      <p>Then update the top-level <code>level</code>, <code>maxHp</code>, and <code>profBonus</code> fields too.</p>
    </div>

    <!-- Level 2 preview per class -->
    <div class="preview-section">
      <h2>Level 2 Preview</h2>
      <p class="intro-text">What each character gets at level 2:</p>
      <div class="preview-grid">
        {active.map(c => {
          const d = c.data;
          const cls = d.class ?? '';
          const previews: Record<string, string[]> = {
            'Rogue':     ['Cunning Action (Dash/Disengage/Hide as bonus action)', 'Choose 2 more Expertise skills'],
            'Artificer': ['Infuse Item (2 infusions, 4 infused items)', 'Spellcasting (Int-based, 2 spell slots)'],
            'Druid':     ['Wild Shape (CR 1/4, no swim/fly)', 'Spellcasting upgrades (3 spell slots)'],
            'Sorcerer':  ['2nd-level spell slot', 'Additional sorcery points (2 total)', 'Font of Magic'],
            'Bard':      ['Jack of All Trades (+half prof to untrained skills)', 'Song of Rest (1d6 HP during rests)', '2nd-level spell slot'],
            'Ranger':    ['Fighting Style', 'Spellcasting (Wis-based, 2 spell slots)'],
            'Barbarian': ['Reckless Attack (advantage on melee, but enemies get it back)', 'Danger Sense (adv on DEX saves vs visible threats)', 'Rage count: 3/day'],
            'Monk':      ['Unarmored Movement +10ft (now 40ft)', 'Dedicated Weapon (optional rule)'],
          };
          const feats = previews[cls] ?? ['Check class rulebook for level 2 features'];
          return (
            <div class="preview-card">
              <div class="preview-header">
                <span class="preview-name">{d.name}</span>
                <span class="preview-class">{cls}</span>
              </div>
              <ul class="preview-features">
                {feats.map(f => <li>{f}</li>)}
              </ul>
            </div>
          );
        })}
      </div>
    </div>

  </div>
</BaseLayout>

<style>
.back-link { margin-bottom: 1.5rem; }
.back-link a { color: var(--text-muted); font-size: 0.85rem; }
.back-link a:hover { color: var(--text-gold); }

.intro-text { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem; }
.gold { color: var(--text-gold-bright); }

.next-level-bar {
  background: rgba(100, 180, 80, 0.07);
  border: 1px solid rgba(100, 180, 80, 0.25);
  border-left: 4px solid #5ba04a;
  border-radius: 0 8px 8px 0;
  padding: 1rem 1.25rem;
  margin-bottom: 2rem;
}
.nlb-label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.4rem;
  color: var(--text-parchment);
  font-size: 0.9rem;
}
.nlb-xp { color: #8dc87a; font-weight: bold; }
.nlb-note { color: var(--text-muted); font-size: 0.8rem; margin: 0; }
.nlb-note code { background: rgba(255,255,255,0.08); padding: 0.1rem 0.3rem; border-radius: 3px; }

/* Character level cards */
.char-level-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}
.char-level-card {
  background: var(--card-bg);
  border: 1px solid var(--border-card);
  border-radius: 8px;
  padding: 1rem;
}
.card-pending { border-color: rgba(220, 140, 0, 0.4); }

.clc-header { margin-bottom: 0.75rem; }
.clc-name-row { display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.15rem; }
.clc-name {
  font-size: 1rem; font-weight: bold;
  color: var(--text-gold);
  text-decoration: none;
}
.clc-name:hover { color: var(--text-gold-bright); }
.clc-player { font-size: 0.72rem; color: var(--text-muted); }
.clc-class-row { display: flex; gap: 0.35rem; align-items: baseline; }
.clc-class { font-size: 0.82rem; color: var(--text-parchment); }
.clc-subclass { font-size: 0.75rem; color: var(--text-muted); font-style: italic; }

.clc-stats {
  display: flex;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
}
.clc-stat {
  flex: 1;
  text-align: center;
  background: rgba(255,255,255,0.04);
  border-radius: 6px;
  padding: 0.4rem 0.5rem;
}
.stat-val {
  display: block;
  font-size: 1.3rem;
  font-weight: bold;
  color: var(--text-gold-bright);
  line-height: 1;
}
.stat-lbl {
  display: block;
  font-size: 0.62rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  margin-top: 0.2rem;
}

.pending-warning {
  font-size: 0.78rem;
  color: #e0a060;
  background: rgba(160, 90, 0, 0.1);
  border: 1px solid rgba(160, 90, 0, 0.25);
  border-radius: 4px;
  padding: 0.3rem 0.5rem;
  margin-bottom: 0.5rem;
}

.level-history { margin-top: 0.5rem; }
.history-label {
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-muted);
  margin-bottom: 0.4rem;
}
.history-row {
  padding: 0.5rem 0.6rem;
  background: rgba(255,255,255,0.03);
  border-radius: 5px;
  margin-bottom: 0.3rem;
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem;
  align-items: flex-start;
}
.history-level {
  font-weight: bold;
  color: var(--text-gold);
  font-size: 0.82rem;
}
.history-session {
  font-size: 0.72rem;
  color: var(--text-muted);
  background: rgba(139,105,20,0.1);
  padding: 0.1rem 0.4rem;
  border-radius: 3px;
}
.history-hp {
  font-size: 0.72rem;
  color: #7dc87a;
  background: rgba(80,160,60,0.1);
  padding: 0.1rem 0.4rem;
  border-radius: 3px;
}
.history-features {
  width: 100%;
  margin: 0.25rem 0 0 0;
  padding-left: 1.1rem;
  list-style: disc;
  font-size: 0.78rem;
  color: var(--text-parchment);
}
.history-features li { margin-bottom: 0.1rem; }
.history-notes {
  width: 100%;
  font-size: 0.75rem;
  color: var(--text-muted);
  font-style: italic;
  margin: 0.2rem 0 0 0;
}

.no-history {
  font-size: 0.77rem;
  color: var(--text-muted);
  font-style: italic;
  margin-top: 0.5rem;
}
.no-history code { background: rgba(255,255,255,0.08); padding: 0.1rem 0.3rem; border-radius: 3px; }

/* How to section */
.howto-section { margin-bottom: 2rem; }
.howto-section h2 { color: var(--text-gold); margin-bottom: 0.75rem; }
.howto-section p { color: var(--text-parchment); font-size: 0.88rem; margin-bottom: 0.75rem; }
.howto-section code { background: rgba(255,255,255,0.08); padding: 0.1rem 0.3rem; border-radius: 3px; }

.code-block {
  background: rgba(0,0,0,0.4);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 6px;
  padding: 1rem 1.25rem;
  font-size: 0.8rem;
  color: #a8d8a8;
  line-height: 1.6;
  overflow-x: auto;
  margin-bottom: 0.75rem;
  white-space: pre;
}

/* Level 2 preview */
.preview-section h2 { color: var(--text-gold); margin-bottom: 0.5rem; }
.preview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 0.75rem;
  margin-top: 1rem;
}
.preview-card {
  background: var(--card-bg);
  border: 1px solid var(--border-card);
  border-radius: 7px;
  padding: 0.85rem 1rem;
}
.preview-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 0.5rem;
}
.preview-name { font-weight: bold; color: var(--text-gold); font-size: 0.9rem; }
.preview-class {
  font-size: 0.72rem;
  color: var(--text-muted);
  background: rgba(139,105,20,0.1);
  padding: 0.1rem 0.4rem;
  border-radius: 3px;
}
.preview-features {
  margin: 0;
  padding-left: 1.1rem;
  list-style: disc;
  font-size: 0.78rem;
  color: var(--text-parchment);
  line-height: 1.6;
}
.preview-features li { margin-bottom: 0.15rem; }
</style>
