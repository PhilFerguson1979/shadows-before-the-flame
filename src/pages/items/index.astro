---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { items, itemsWithSlugs, itemCategories, type ItemWithSlug } from '../../data/items';

const base = import.meta.env.BASE_URL.replace(/\/$/, '');

// Group items by category
const itemsByCategory = new Map<string, ItemWithSlug[]>();
const categoryOrder = [
  'Simple Weapons',
  'Martial Weapons',
  'Armor',
  'Shields',
  'Ammunition',
  'Adventuring Gear',
  'Tools',
  'Potions',
  'Magic Items',
];

// Sort into the defined order, then any remaining categories alphabetically
const allCats = [...new Set(itemsWithSlugs.map(i => i.category).filter(Boolean))] as string[];
const orderedCats = [
  ...categoryOrder.filter(c => allCats.includes(c)),
  ...allCats.filter(c => !categoryOrder.includes(c)).sort(),
];

orderedCats.forEach(cat => {
  const group = itemsWithSlugs
    .filter(i => i.category === cat)
    .sort((a, b) => a.name.localeCompare(b.name));
  if (group.length > 0) itemsByCategory.set(cat, group);
});

// Collect unique values for filter dropdowns
const allTypes = [...new Set(itemsWithSlugs.map(i => i.type))].sort();
const allRarities = [...new Set(itemsWithSlugs.map(i => i.rarity).filter(Boolean))].sort() as string[];

function rarityColor(rarity?: string): string {
  switch (rarity) {
    case 'common': return '#9d9d9d';
    case 'uncommon': return '#1fc219';
    case 'rare': return '#4fc3f7';
    case 'very rare': return '#ab47bc';
    case 'legendary': return '#ff8f00';
    default: return '';
  }
}

function typeIcon(type: string): string {
  switch (type) {
    case 'weapon': return '‚öîÔ∏è';
    case 'armor': return 'üõ°Ô∏è';
    case 'shield': return 'üõ°Ô∏è';
    case 'gear': return 'üéí';
    case 'tool': return 'üîß';
    case 'potion': return 'üß™';
    case 'wondrous': return '‚ú®';
    case 'ring': return 'üíç';
    case 'cloak': return 'üß•';
    case 'boots': return 'üë¢';
    case 'gloves': return 'üß§';
    case 'helmet': return '‚õëÔ∏è';
    case 'amulet': return 'üìø';
    case 'misc': return '‚ú®';
    default: return 'üì¶';
  }
}
---

<BaseLayout title="Item Browser">
  <div class="page-container">
    <h1>Item Browser</h1>
    <p class="item-count">{items.length} items from the D&D 5e equipment catalog</p>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="filter-group">
        <label for="search-input">Search</label>
        <input type="text" id="search-input" placeholder="Item name..." autocomplete="off" />
      </div>
      <div class="filter-group">
        <label for="category-filter">Category</label>
        <select id="category-filter">
          <option value="">All Categories</option>
          {orderedCats.map(cat => (
            <option value={cat}>{cat}</option>
          ))}
        </select>
      </div>
      <div class="filter-group">
        <label for="type-filter">Type</label>
        <select id="type-filter">
          <option value="">All Types</option>
          {allTypes.map(t => (
            <option value={t}>{t.charAt(0).toUpperCase() + t.slice(1)}</option>
          ))}
        </select>
      </div>
      <div class="filter-group">
        <label for="rarity-filter">Rarity</label>
        <select id="rarity-filter">
          <option value="">All Rarities</option>
          {allRarities.map(r => (
            <option value={r}>{r.charAt(0).toUpperCase() + r.slice(1)}</option>
          ))}
        </select>
      </div>
      <div class="filter-group filter-toggles">
        <label>
          <input type="checkbox" id="magical-filter" /> Magical Only
        </label>
      </div>
      <button id="clear-filters" class="clear-btn">Clear</button>
    </div>

    <div id="no-results" class="no-results" style="display:none;">
      No items match your filters.
    </div>

    <!-- Item Category Sections -->
    {[...itemsByCategory.entries()].map(([cat, catItems]) => (
      <div class="category-section" data-category={cat}>
        <button class="category-header" data-toggle={cat}>
          <span class="category-label">{cat}</span>
          <span class="category-count">{catItems.length} items</span>
          <span class="toggle-icon">‚ñº</span>
        </button>
        <div class="category-grid" id={`cat-${cat.toLowerCase().replace(/\s+/g, '-')}`}>
          {catItems.map(item => (
            <a
              href={`${base}/items/${item.slug}`}
              class="item-card"
              data-name={item.name.toLowerCase()}
              data-category={item.category}
              data-type={item.type}
              data-rarity={item.rarity || ''}
              data-magical={item.magical ? 'true' : 'false'}
            >
              <div class="item-card-top">
                <span class="item-icon">{typeIcon(item.type)}</span>
                <span class="item-name">{item.name}</span>
                {item.magical && <span class="magic-star">‚òÖ</span>}
              </div>
              <div class="item-card-meta">
                {item.dmg && <span class="item-dmg">{item.dmg} {item.dmgType}</span>}
                {item.acBase && <span class="item-ac">AC {item.acBase}</span>}
                {item.acBonus && !item.acBase && <span class="item-ac">+{item.acBonus} AC</span>}
                {item.value && <span class="item-value">{item.value}</span>}
              </div>
              <div class="item-card-tags">
                {item.rarity && (
                  <span class="tag rarity" style={`color:${rarityColor(item.rarity)};border-color:${rarityColor(item.rarity)}40;background:${rarityColor(item.rarity)}15`}>
                    {item.rarity}
                  </span>
                )}
                {item.properties && item.properties.length > 0 && (
                  <span class="tag props">{item.properties.slice(0, 3).join(', ')}{item.properties.length > 3 ? '...' : ''}</span>
                )}
              </div>
              {item.notes && (
                <div class="item-card-notes">{item.notes.length > 60 ? item.notes.slice(0, 57) + '...' : item.notes}</div>
              )}
            </a>
          ))}
        </div>
      </div>
    ))}
  </div>
</BaseLayout>

<script>
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const categoryFilter = document.getElementById('category-filter') as HTMLSelectElement;
  const typeFilter = document.getElementById('type-filter') as HTMLSelectElement;
  const rarityFilter = document.getElementById('rarity-filter') as HTMLSelectElement;
  const magicalFilter = document.getElementById('magical-filter') as HTMLInputElement;
  const clearBtn = document.getElementById('clear-filters');
  const noResults = document.getElementById('no-results');

  // Toggle category sections
  document.querySelectorAll('.category-header').forEach(btn => {
    btn.addEventListener('click', () => {
      const cat = (btn as HTMLElement).dataset.toggle;
      const slug = cat?.toLowerCase().replace(/\s+/g, '-');
      const grid = document.getElementById(`cat-${slug}`);
      const icon = btn.querySelector('.toggle-icon');
      if (grid) {
        grid.classList.toggle('collapsed');
        if (icon) icon.textContent = grid.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
      }
    });
  });

  function applyFilters() {
    const search = searchInput.value.toLowerCase().trim();
    const cat = categoryFilter.value;
    const type = typeFilter.value;
    const rarity = rarityFilter.value;
    const magicalOnly = magicalFilter.checked;

    let totalVisible = 0;

    document.querySelectorAll('.item-card').forEach(card => {
      const el = card as HTMLElement;
      const name = el.dataset.name || '';
      const cardCat = el.dataset.category || '';
      const cardType = el.dataset.type || '';
      const cardRarity = el.dataset.rarity || '';
      const isMagical = el.dataset.magical === 'true';

      let show = true;
      if (search && !name.includes(search)) show = false;
      if (cat && cardCat !== cat) show = false;
      if (type && cardType !== type) show = false;
      if (rarity && cardRarity !== rarity) show = false;
      if (magicalOnly && !isMagical) show = false;

      el.style.display = show ? '' : 'none';
      if (show) totalVisible++;
    });

    // Hide empty category sections
    document.querySelectorAll('.category-section').forEach(section => {
      const cards = section.querySelectorAll('.item-card');
      let sectionVisible = 0;
      cards.forEach(c => {
        if ((c as HTMLElement).style.display !== 'none') sectionVisible++;
      });
      (section as HTMLElement).style.display = sectionVisible > 0 ? '' : 'none';

      // Update count
      const countEl = section.querySelector('.category-count');
      if (countEl) {
        const total = cards.length;
        countEl.textContent = sectionVisible === total
          ? `${total} items`
          : `${sectionVisible} / ${total} items`;
      }
    });

    if (noResults) {
      noResults.style.display = totalVisible === 0 ? '' : 'none';
    }
  }

  searchInput.addEventListener('input', applyFilters);
  categoryFilter.addEventListener('change', applyFilters);
  typeFilter.addEventListener('change', applyFilters);
  rarityFilter.addEventListener('change', applyFilters);
  magicalFilter.addEventListener('change', applyFilters);

  clearBtn?.addEventListener('click', () => {
    searchInput.value = '';
    categoryFilter.value = '';
    typeFilter.value = '';
    rarityFilter.value = '';
    magicalFilter.checked = false;
    applyFilters();
  });
</script>

<style>
h1 { margin-bottom: 0.25rem; }
.item-count {
  font-size: 0.82rem;
  color: var(--text-muted);
  margin-bottom: 1.5rem;
}

/* Filter bar */
.filter-bar {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
  align-items: flex-end;
  margin-bottom: 2rem;
  padding: 1rem;
  background: rgba(200,150,50,0.04);
  border: 1px solid rgba(200,150,50,0.15);
  border-radius: 8px;
}
.filter-group {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}
.filter-group label {
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
}
.filter-group input[type="text"],
.filter-group select {
  padding: 0.4rem 0.6rem;
  font-size: 0.82rem;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(0,201,167,0.3);
  border-radius: 4px;
  color: var(--text-normal);
  min-width: 140px;
}
.filter-group input[type="text"]:focus,
.filter-group select:focus {
  outline: none;
  border-color: var(--accent-primary);
}
.filter-toggles {
  flex-direction: row;
  gap: 0.75rem;
  align-items: center;
  padding-bottom: 0.2rem;
}
.filter-toggles label {
  display: flex;
  align-items: center;
  gap: 0.3rem;
  font-size: 0.78rem;
  cursor: pointer;
  text-transform: none;
  letter-spacing: normal;
}
.filter-toggles input[type="checkbox"] {
  accent-color: var(--accent-primary);
}
.clear-btn {
  padding: 0.4rem 0.8rem;
  font-size: 0.78rem;
  background: rgba(0,201,167,0.15);
  border: 1px solid rgba(0,201,167,0.3);
  border-radius: 4px;
  color: var(--accent-primary);
  cursor: pointer;
  transition: all 0.15s ease;
}
.clear-btn:hover {
  background: rgba(0,201,167,0.25);
}

.no-results {
  text-align: center;
  padding: 3rem;
  color: var(--text-muted);
  font-style: italic;
}

/* Category sections */
.category-section {
  margin-bottom: 1.5rem;
}
.category-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  width: 100%;
  padding: 0.6rem 0.8rem;
  background: rgba(200,150,50,0.08);
  border: 1px solid rgba(200,150,50,0.2);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.15s ease;
  color: inherit;
  font-family: inherit;
  text-align: left;
}
.category-header:hover {
  background: rgba(200,150,50,0.14);
}
.category-label {
  font-size: 0.88rem;
  font-weight: bold;
  color: var(--accent-primary);
  text-transform: uppercase;
  letter-spacing: 0.06em;
}
.category-count {
  font-size: 0.72rem;
  color: var(--text-muted);
}
.toggle-icon {
  margin-left: auto;
  font-size: 0.7rem;
  color: var(--text-muted);
  transition: transform 0.2s ease;
}

/* Item grid */
.category-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 0.5rem;
  padding: 0.75rem 0;
  transition: all 0.2s ease;
}
.category-grid.collapsed {
  display: none;
}

/* Item cards */
.item-card {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  padding: 0.55rem 0.75rem;
  background: rgba(200,150,50,0.04);
  border: 1px solid rgba(200,150,50,0.12);
  border-radius: 5px;
  text-decoration: none;
  transition: all 0.15s ease;
}
.item-card:hover {
  background: rgba(200,150,50,0.1);
  border-color: rgba(200,150,50,0.3);
  transform: translateY(-1px);
}
.item-card-top {
  display: flex;
  align-items: center;
  gap: 0.4rem;
}
.item-icon {
  font-size: 0.85rem;
  flex-shrink: 0;
}
.item-name {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-normal);
  flex: 1;
}
.magic-star {
  color: #f0c040;
  font-size: 0.75rem;
  flex-shrink: 0;
}
.item-card-meta {
  display: flex;
  gap: 0.75rem;
  font-size: 0.72rem;
  color: var(--text-muted);
  padding-left: 1.25rem;
}
.item-dmg { color: #e57373; }
.item-ac { color: #64b5f6; }
.item-value { color: #ffd54f; }
.item-card-tags {
  display: flex;
  gap: 0.3rem;
  padding-left: 1.25rem;
  flex-wrap: wrap;
}
.tag {
  font-size: 0.58rem;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  padding: 0.08rem 0.3rem;
  border-radius: 2px;
  font-weight: bold;
}
.tag.rarity {
  border: 1px solid;
}
.tag.props {
  background: rgba(100,100,100,0.12);
  color: var(--text-dim);
  border: 1px solid rgba(100,100,100,0.2);
  text-transform: none;
}
.item-card-notes {
  font-size: 0.68rem;
  color: var(--text-dim);
  padding-left: 1.25rem;
  font-style: italic;
  line-height: 1.3;
}

@media (max-width: 640px) {
  .filter-bar { flex-direction: column; align-items: stretch; }
  .filter-group input[type="text"],
  .filter-group select { min-width: auto; width: 100%; }
  .category-grid { grid-template-columns: 1fr; }
}
</style>
