---
import '../styles/global.css';

export interface Props {
  title: string;
  description?: string;
}

const { title, description = "Shadows Before The Flame â€” A Dragonlance 5e Campaign" } = Astro.props;
const currentPath = Astro.url.pathname;
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

// Grouped navigation with dropdowns
const navGroups = [
  { href: `${base}/`, label: 'Home' },
  {
    label: 'Party',
    children: [
      { href: `${base}/characters`, label: 'Characters' },
      { href: `${base}/party/level-tracker`, label: 'Level Tracker' },
      { href: `${base}/party/level-up`, label: 'Level Up' },
      { href: `${base}/party/initiative`, label: 'Combat Initiative' },
      { href: `${base}/character-creation`, label: 'Create Character' },
    ],
  },
  { href: `${base}/sessions`, label: 'Sessions' },
  {
    label: 'World',
    children: [
      { href: `${base}/npcs`, label: 'NPCs' },
      { href: `${base}/locations`, label: 'Locations' },
      { href: `${base}/lore`, label: 'Lore' },
      { href: `${base}/monsters`, label: 'Bestiary' },
      { href: `${base}/encounters`, label: 'Encounters' },
    ],
  },
  {
    label: 'Reference',
    children: [
      { href: `${base}/classes`, label: 'Classes' },
      { href: `${base}/items`, label: 'Items & Equipment' },
      { href: `${base}/spells`, label: 'Spells' },
      { href: `${base}/skills`, label: 'Skills' },
      { href: `${base}/feats`, label: 'Feats' },
    ],
  },
  { href: `${base}/inventory`, label: 'Inventory' },
  { href: `${base}/dm`, label: 'DM Tools' },
];

function isActive(href: string): boolean {
  return currentPath === href || (href !== `${base}/` && currentPath.startsWith(href));
}

function isGroupActive(children: { href: string }[]): boolean {
  return children.some(c => isActive(c.href));
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content={description} />
  <title>{title} | Shadows Before The Flame</title>
  <link rel="icon" type="image/svg+xml" href={`${base}/favicon.svg`} />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
</head>
<body>
  <!-- Nav -->
  <header class="site-header">
    <div class="header-inner">
      <a href={`${base}/`} class="site-title">
        <span class="title-main">Shadows Before The Flame</span>
        <span class="title-sub">A Dragonlance 5e Campaign</span>
      </a>

      <!-- Mobile hamburger -->
      <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
        <span></span><span></span><span></span>
      </button>

      <nav class="main-nav" id="mainNav">
        {navGroups.map(group => (
          'children' in group && group.children ? (
            <div class={`nav-dropdown ${isGroupActive(group.children) ? 'active' : ''}`}>
              <button class="nav-link dropdown-trigger" type="button">
                {group.label}
                <svg class="dropdown-arrow" width="10" height="6" viewBox="0 0 10 6" fill="none">
                  <path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <div class="dropdown-menu">
                {group.children.map(child => (
                  <a
                    href={child.href}
                    class={`dropdown-item ${isActive(child.href) ? 'active' : ''}`}
                  >
                    {child.label}
                  </a>
                ))}
              </div>
            </div>
          ) : (
            <a
              href={group.href}
              class={`nav-link ${isActive(group.href!) ? 'active' : ''}`}
            >
              {group.label}
            </a>
          )
        ))}
      </nav>
    </div>
  </header>

  <!-- Main content -->
  <main>
    <slot />
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-inner">
      <p>Shadows Before The Flame &mdash; Dragonlance 5e &mdash; Session {new Date().getFullYear()}</p>
      <p class="footer-sub">The fate of Krynn hangs in the balance.</p>
    </div>
  </footer>

  <script>
    // Mobile nav toggle
    const toggle = document.getElementById('navToggle');
    const nav = document.getElementById('mainNav');
    toggle?.addEventListener('click', () => {
      nav?.classList.toggle('open');
      toggle.classList.toggle('open');
    });

    // Dropdown toggle (click-based for both desktop and mobile)
    document.querySelectorAll('.dropdown-trigger').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const dropdown = btn.closest('.nav-dropdown');
        if (!dropdown) return;
        const wasOpen = dropdown.classList.contains('open');
        // Close all other dropdowns
        document.querySelectorAll('.nav-dropdown.open').forEach(d => d.classList.remove('open'));
        // Toggle this one
        if (!wasOpen) dropdown.classList.add('open');
      });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', () => {
      document.querySelectorAll('.nav-dropdown.open').forEach(d => d.classList.remove('open'));
    });

    // Prevent dropdown menu clicks from closing the dropdown
    document.querySelectorAll('.dropdown-menu').forEach(menu => {
      menu.addEventListener('click', (e) => e.stopPropagation());
    });
  </script>
</body>
</html>

<style>
.site-header {
  background: linear-gradient(180deg, #0e0f14 0%, #12141a 100%);
  border-bottom: 1px solid var(--border-accent);
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 20px rgba(0,0,0,0.6);
}
.header-inner {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1.5rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 2rem;
  min-height: 64px;
}
.site-title {
  display: flex;
  flex-direction: column;
  text-decoration: none;
  flex-shrink: 0;
}
.title-main {
  color: var(--text-bright);
  font-family: 'Cinzel', 'Georgia', serif;
  font-size: 1.1rem;
  font-weight: 700;
  letter-spacing: 0.03em;
  line-height: 1.2;
}
.title-sub {
  color: var(--accent-primary-dim);
  font-size: 0.65rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  font-family: 'Inter', sans-serif;
}
.main-nav {
  display: flex;
  align-items: center;
  gap: 0.15rem;
  flex-wrap: wrap;
}
.nav-link {
  color: var(--text-normal);
  font-size: 0.82rem;
  font-family: 'Inter', sans-serif;
  padding: 0.4rem 0.7rem;
  border-radius: 6px;
  transition: all 0.2s;
  letter-spacing: 0.02em;
  border: 1px solid transparent;
  text-decoration: none;
  white-space: nowrap;
}
.nav-link:hover {
  color: var(--accent-primary);
  background: rgba(0,201,167,0.06);
  border-color: rgba(0,201,167,0.15);
}
.nav-link.active,
.nav-dropdown.active > .dropdown-trigger {
  color: var(--accent-primary);
  background: rgba(0,201,167,0.1);
  border-color: var(--border-accent);
  font-weight: 500;
}

/* --- Dropdown trigger button --- */
.dropdown-trigger {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  cursor: pointer;
  background: none;
}
.dropdown-arrow {
  width: 10px;
  height: 6px;
  transition: transform 0.2s;
  flex-shrink: 0;
}
.nav-dropdown.open .dropdown-arrow {
  transform: rotate(180deg);
}

/* --- Dropdown container --- */
.nav-dropdown {
  position: relative;
}

/* --- Dropdown menu panel --- */
.dropdown-menu {
  display: none;
  position: absolute;
  top: calc(100% + 0.5rem);
  left: 50%;
  transform: translateX(-50%);
  min-width: 200px;
  background: #181b24;
  border: 1px solid rgba(0,201,167,0.25);
  border-radius: 8px;
  padding: 0.4rem;
  box-shadow: 0 8px 30px rgba(0,0,0,0.6), 0 0 15px rgba(0,201,167,0.05);
  z-index: 200;
  flex-direction: column;
  gap: 0.1rem;
}
.nav-dropdown.open > .dropdown-menu {
  display: flex;
}

/* --- Dropdown menu items --- */
.dropdown-item {
  display: block;
  padding: 0.55rem 0.9rem;
  color: var(--text-normal);
  font-size: 0.85rem;
  font-family: 'Inter', sans-serif;
  text-decoration: none;
  border-radius: 5px;
  transition: all 0.15s;
  white-space: nowrap;
}
.dropdown-item:hover {
  color: var(--accent-primary);
  background: rgba(0,201,167,0.1);
}
.dropdown-item.active {
  color: var(--accent-primary);
  background: rgba(0,201,167,0.08);
  font-weight: 500;
}

/* --- Nav toggle (hamburger) --- */
.nav-toggle {
  display: none;
  flex-direction: column;
  gap: 5px;
  background: none;
  border: none;
  cursor: pointer;
  padding: 0.5rem;
}
.nav-toggle span {
  display: block;
  width: 24px;
  height: 2px;
  background: var(--accent-primary);
  border-radius: 2px;
  transition: all 0.3s;
}
.nav-toggle.open span:nth-child(1) {
  transform: rotate(45deg) translate(5px, 5px);
}
.nav-toggle.open span:nth-child(2) {
  opacity: 0;
}
.nav-toggle.open span:nth-child(3) {
  transform: rotate(-45deg) translate(5px, -5px);
}

/* --- Footer --- */
.site-footer {
  border-top: 1px solid var(--border-default);
  margin-top: 4rem;
  padding: 2rem 1.5rem;
  text-align: center;
  opacity: 0.5;
}
.footer-inner p { color: var(--text-muted); font-size: 0.8rem; margin: 0; font-family: 'Inter', sans-serif; }
.footer-sub { font-style: italic; margin-top: 0.25rem !important; }

/* --- Mobile --- */
@media (max-width: 768px) {
  .nav-toggle { display: flex; }
  .main-nav {
    display: none;
    position: absolute;
    top: 64px;
    left: 0; right: 0;
    background: #12141a;
    border-bottom: 1px solid var(--border-accent);
    flex-direction: column;
    padding: 0.75rem;
    gap: 0.15rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    max-height: calc(100vh - 64px);
    overflow-y: auto;
  }
  .main-nav.open { display: flex; }
  .nav-link { padding: 0.65rem 1rem; font-size: 0.9rem; }
  .title-main { font-size: 0.95rem; }

  /* Mobile dropdowns are inline, not absolute */
  .nav-dropdown { position: static; }
  .dropdown-menu {
    position: static;
    transform: none;
    min-width: 0;
    background: rgba(0,201,167,0.04);
    border: none;
    border-left: 2px solid var(--accent-primary-dim);
    border-radius: 0 6px 6px 0;
    margin: 0.15rem 0 0.15rem 0.75rem;
    padding: 0.25rem;
    box-shadow: none;
  }
  .dropdown-item {
    padding: 0.5rem 0.9rem;
    font-size: 0.85rem;
  }
}
</style>
